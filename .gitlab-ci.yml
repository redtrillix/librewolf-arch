image: registry.gitlab.com/ohfp/manjaro-arm-docker

variables:
  REPONAME: "librewolf"
  REPODIR: "$CI_PROJECT_DIR"
  GET_SOURCES_ATTEMPTS: 5
  XZ_DEFAULTS: "-T 0"


cache:
    key: "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHA}"


before_script:
  - pacman --noconfirm -Syu --needed base-devel

  # this is a very ugly fix for recent makepkg-5.1-chmod-shenanigans, which fuck up the build process in docker
  - sed -E -i 's/^chmod a-s \"\$BUILDDIR\"$/# chmod a-s \"\$BUILDDIR\"/' `which makepkg`

  # The repository build script is run by user 'nobody'. The build scripts needs
  # to install dependencies using pacman. This requires root permissions.
  # (Note: the build script itself can't be run as root, as makepkg would
  # complain)
  - "echo 'nobody ALL=(ALL) NOPASSWD: /usr/bin/pacman' >> /etc/sudoers"

  # a writable home-directory is needed by import-validpgpkeys.sh
  - mkdir -p /home/nobody && chown -R nobody /home/nobody
  - usermod -d /home/nobody nobody
  # we need to un-expire the account, otherwise PAM will complain
  - usermod -e '' nobody
  - chown -R nobody .

build_repo:
  script:
    - cd 'ci/librewolf'
    - sudo -u nobody -E -H makepkg --noconfirm --nosign --syncdeps --cleanbuild --skippgpcheck

  artifacts:
    # expire artifacts per default - the gitlab web frontend can be used to keep
    # artifacts of interest for an unlimited time
    expire_in: 1 year
    paths:
      - "**/*.pkg.tar."
  tags: [aarch64]
  only:
    - tags
